<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products - TechStore</title>

    <!-- Bootstrap CSS -->
    <link th:href="@{/webjars/bootstrap/5.3.2/css/bootstrap.min.css}" rel="stylesheet">
    <!-- Font Awesome -->
    <link th:href="@{/webjars/font-awesome/6.4.0/css/all.min.css}" rel="stylesheet">

    <style>
        .filter-sidebar {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .product-card {
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            height: 100%;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }
        .product-image {
            height: 200px;
            object-fit: cover;
            background: #f8f9fa;
        }
        .price {
            color: #e74c3c;
            font-weight: bold;
            font-size: 1.2rem;
        }
        .stock-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 2;
        }
        .pagination .page-link {
            border-radius: 8px;
            margin: 0 2px;
            border: 1px solid #dee2e6;
        }
        .pagination .page-link:hover {
            background-color: #667eea;
            border-color: #667eea;
            color: white;
        }
        .pagination .page-item.active .page-link {
            background-color: #667eea;
            border-color: #667eea;
        }
        .filter-title {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 15px;
        }
        .category-filter {
            cursor: pointer;
            padding: 8px 12px;
            margin: 2px 0;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        .category-filter:hover {
            background-color: #e9ecef;
        }
        .category-filter.active {
            background-color: #667eea;
            color: white;
        }
        .search-results-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            border-radius: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
    <div class="container">
        <a class="navbar-brand" th:href="@{/}">
            <i class="fas fa-store"></i> TechStore
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/}">
                        <i class="fas fa-home"></i> Home
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" th:href="@{/products}">
                        <i class="fas fa-box"></i> Products
                    </a>
                </li>
            </ul>

            <!-- Search Form -->
            <form class="d-flex me-3" id="searchForm">
                <input class="form-control me-2" type="search" id="searchInput" placeholder="Search products..." aria-label="Search">
                <button class="btn btn-outline-light" type="submit">
                    <i class="fas fa-search"></i>
                </button>
            </form>

            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link position-relative" th:href="@{/cart}" id="cartLink" style="display: none;">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="cartCount">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/login}" id="loginLink">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <!-- Search Results Header -->
    <div id="searchResultsHeader" style="display: none;">
        <div class="search-results-header text-center">
            <h3><i class="fas fa-search me-2"></i>Search Results</h3>
            <p class="mb-0">Showing results for: <strong id="searchTerm"></strong></p>
        </div>
    </div>

    <div class="row">
        <!-- Filters Sidebar -->
        <div class="col-lg-3 col-md-4">
            <div class="filter-sidebar sticky-top" style="top: 100px;">
                <h5 class="filter-title"><i class="fas fa-filter me-2"></i>Filters</h5>

                <!-- Categories -->
                <div class="mb-4">
                    <h6 class="fw-bold">Categories</h6>
                    <div id="categoryFilters">
                        <div class="category-filter" data-category="all">
                            <i class="fas fa-th-large me-2"></i>All Categories
                        </div>
                        <!-- Categories will be loaded here -->
                    </div>
                </div>

                <!-- Price Range -->
                <div class="mb-4">
                    <h6 class="fw-bold">Price Range</h6>
                    <div class="row">
                        <div class="col-6">
                            <input type="number" class="form-control form-control-sm" id="minPrice" placeholder="Min $">
                        </div>
                        <div class="col-6">
                            <input type="number" class="form-control form-control-sm" id="maxPrice" placeholder="Max $">
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-primary w-100 mt-2" onclick="applyPriceFilter()">
                        Apply Price Filter
                    </button>
                </div>

                <!-- Availability -->
                <div class="mb-4">
                    <h6 class="fw-bold">Availability</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="inStock">
                        <label class="form-check-label" for="inStock">
                            In Stock Only
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="featured">
                        <label class="form-check-label" for="featured">
                            Featured Products
                        </label>
                    </div>
                </div>

                <!-- Sort Options -->
                <div class="mb-4">
                    <h6 class="fw-bold">Sort By</h6>
                    <select class="form-select form-select-sm" id="sortSelect">
                        <option value="name-asc">Name (A-Z)</option>
                        <option value="name-desc">Name (Z-A)</option>
                        <option value="price-asc">Price (Low to High)</option>
                        <option value="price-desc">Price (High to Low)</option>
                        <option value="createdAt-desc">Newest First</option>
                        <option value="createdAt-asc">Oldest First</option>
                    </select>
                </div>

                <!-- Clear Filters -->
                <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                    <i class="fas fa-times me-2"></i>Clear All Filters
                </button>
            </div>
        </div>

        <!-- Products Grid -->
        <div class="col-lg-9 col-md-8">
            <!-- Products Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h4 class="mb-0">Products</h4>
                    <small class="text-muted" id="productCount">Loading...</small>
                </div>
                <div class="d-flex align-items-center">
                    <label for="pageSize" class="form-label me-2 mb-0">Show:</label>
                    <select class="form-select form-select-sm" id="pageSize" style="width: auto;">
                        <option value="12" selected>12</option>
                        <option value="24">24</option>
                        <option value="48">48</option>
                    </select>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Loading products...</p>
            </div>

            <!-- Products Grid -->
            <div class="row" id="productsGrid">
                <!-- Products will be loaded here -->
            </div>

            <!-- No Products Message -->
            <div id="noProductsMessage" class="text-center py-5" style="display: none;">
                <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No products found</h5>
                <p class="text-muted">Try adjusting your filters or search terms</p>
            </div>

            <!-- Pagination -->
            <nav aria-label="Products pagination" class="mt-4">
                <ul class="pagination justify-content-center" id="pagination">
                    <!-- Pagination will be generated here -->
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Footer -->
<footer class="bg-dark text-light py-5 mt-5">
    <div class="container">
        <div class="row">
            <div class="col-md-4">
                <h5><i class="fas fa-store"></i> TechStore</h5>
                <p>Your one-stop destination for cutting-edge technology.</p>
            </div>
            <div class="col-md-4">
                <h6>Quick Links</h6>
                <ul class="list-unstyled">
                    <li><a th:href="@{/}" class="text-light">Home</a></li>
                    <li><a th:href="@{/products}" class="text-light">Products</a></li>
                    <li><a th:href="@{/swagger-ui.html}" class="text-light">API Documentation</a></li>
                </ul>
            </div>
            <div class="col-md-4">
                <h6>Support</h6>
                <ul class="list-unstyled">
                    <li><a href="#" class="text-light">Contact Us</a></li>
                    <li><a href="#" class="text-light">FAQ</a></li>
                    <li><a href="#" class="text-light">Shipping Info</a></li>
                </ul>
            </div>
        </div>
        <hr class="my-4">
        <div class="text-center">
            <p class="mb-0">&copy; 2024 TechStore. Built with Spring Boot & ❤️</p>
        </div>
    </div>
</footer>

<!-- Scripts -->
<script th:src="@{/webjars/jquery/3.7.1/jquery.min.js}"></script>
<script th:src="@{/webjars/bootstrap/5.3.2/js/bootstrap.bundle.min.js}"></script>

<script>
    let currentPage = 0;
    let currentFilters = {
        search: '',
        categoryId: null,
        minPrice: null,
        maxPrice: null,
        inStock: null,
        featured: null,
        sortBy: 'name',
        sortDir: 'asc',
        size: 12
    };
    let totalPages = 0;
    let authToken = localStorage.getItem('authToken');

    $(document).ready(function() {
        initializePage();
        loadCategories();
        loadProducts();

        // Check authentication state
        if (authToken) {
            $('#loginLink').hide();
            $('#cartLink').show();
            updateCartCount();
        }

        // Event listeners
        $('#searchForm').on('submit', function(e) {
            e.preventDefault();
            performSearch();
        });

        $('#pageSize').on('change', function() {
            currentFilters.size = parseInt($(this).val());
            currentPage = 0;
            loadProducts();
        });

        $('#sortSelect').on('change', function() {
            const [sortBy, sortDir] = $(this).val().split('-');
            currentFilters.sortBy = sortBy;
            currentFilters.sortDir = sortDir;
            currentPage = 0;
            loadProducts();
        });

        $('#inStock, #featured').on('change', function() {
            applyAvailabilityFilter();
        });
    });

    function initializePage() {
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const search = urlParams.get('search');
        const categoryId = urlParams.get('categoryId');

        if (search) {
            currentFilters.search = search;
            $('#searchInput').val(search);
            $('#searchResultsHeader').show();
            $('#searchTerm').text(search);
        }

        if (categoryId) {
            currentFilters.categoryId = parseInt(categoryId);
        }
    }

    function loadCategories() {
        $.ajax({
            url: '/api/categories',
            method: 'GET',
            success: function(response) {
                if (response.success && response.data) {
                    displayCategories(response.data);
                }
            },
            error: function() {
                console.error('Failed to load categories');
            }
        });
    }

    function displayCategories(categories) {
        let html = '<div class="category-filter active" data-category="all"><i class="fas fa-th-large me-2"></i>All Categories</div>';

        categories.forEach(category => {
            const isActive = currentFilters.categoryId === category.id ? 'active' : '';
            html += `
                <div class="category-filter ${isActive}" data-category="${category.id}">
                    <i class="fas fa-tag me-2"></i>${category.name}
                </div>
            `;
        });

        $('#categoryFilters').html(html);

        // Add click handlers
        $('.category-filter').on('click', function() {
            $('.category-filter').removeClass('active');
            $(this).addClass('active');

            const categoryId = $(this).data('category');
            currentFilters.categoryId = categoryId === 'all' ? null : categoryId;
            currentPage = 0;
            loadProducts();
        });
    }

    function loadProducts() {
        $('#loadingSpinner').show();
        $('#productsGrid').empty();
        $('#noProductsMessage').hide();

        const params = {
            page: currentPage,
            size: currentFilters.size,
            sortBy: currentFilters.sortBy,
            sortDir: currentFilters.sortDir
        };

        // Add optional filters
        if (currentFilters.search) params.search = currentFilters.search;
        if (currentFilters.categoryId) params.categoryId = currentFilters.categoryId;
        if (currentFilters.minPrice) params.minPrice = currentFilters.minPrice;
        if (currentFilters.maxPrice) params.maxPrice = currentFilters.maxPrice;
        if (currentFilters.inStock !== null) params.inStock = currentFilters.inStock;
        if (currentFilters.featured !== null) params.featured = currentFilters.featured;

        $.ajax({
            url: '/api/products',
            method: 'GET',
            data: params,
            success: function(response) {
                $('#loadingSpinner').hide();

                if (response.success && response.products) {
                    displayProducts(response.products);
                    updatePagination(response);
                    updateProductCount(response.totalItems);
                } else {
                    $('#noProductsMessage').show();
                    updateProductCount(0);
                }
            },
            error: function() {
                $('#loadingSpinner').hide();
                $('#noProductsMessage').show();
                updateProductCount(0);
            }
        });
    }

    function displayProducts(products) {
        if (products.length === 0) {
            $('#noProductsMessage').show();
            return;
        }

        let html = '';
        products.forEach(product => {
            const stockBadge = product.stockQuantity > 0
                ? `<span class="badge bg-success stock-badge">In Stock</span>`
                : `<span class="badge bg-danger stock-badge">Out of Stock</span>`;

            const addToCartBtn = product.stockQuantity > 0
                ? `<button onclick="addToCart(${product.id})" class="btn btn-primary btn-sm"><i class="fas fa-cart-plus"></i></button>`
                : `<button class="btn btn-secondary btn-sm" disabled><i class="fas fa-ban"></i></button>`;

            html += `
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card product-card">
                        <div class="position-relative">
                            ${stockBadge}
                            <div class="product-image d-flex align-items-center justify-content-center" style="height: 200px; background: #f8f9fa;">
                                ${product.images && product.images.length > 0
                                    ? `<img src="${product.images[0]}" class="img-fluid" alt="${product.name}" style="max-height: 180px; object-fit: contain;">`
                                    : `<i class="fas fa-box fa-3x text-muted"></i>`
                                }
                            </div>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">${product.name}</h5>
                            <p class="card-text text-muted flex-grow-1">${product.description.substring(0, 100)}...</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="price">${parseFloat(product.price).toFixed(2)}</span>
                                <div class="btn-group">
                                    <a href="/product/${product.id}" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    ${addToCartBtn}
                                </div>
                            </div>
                            ${product.categoryName ? `<small class="text-muted mt-2"><i class="fas fa-tag me-1"></i>${product.categoryName}</small>` : ''}
                        </div>
                    </div>
                </div>
            `;
        });

        $('#productsGrid').html(html);
    }

    function updatePagination(response) {
        totalPages = response.totalPages;
        let html = '';

        // Previous button
        html += `
            <li class="page-item ${currentPage === 0 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
        `;

        // Page numbers
        for (let i = 0; i < totalPages; i++) {
            if (i === currentPage || i === 0 || i === totalPages - 1 ||
                (i >= currentPage - 1 && i <= currentPage + 1)) {
                html += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i + 1}</a>
                    </li>
                `;
            } else if (i === 1 && currentPage > 3) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            } else if (i === totalPages - 2 && currentPage < totalPages - 4) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }

        // Next button
        html += `
            <li class="page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        `;

        $('#pagination').html(html);
    }

    function updateProductCount(count) {
        $('#productCount').text(`${count} product${count !== 1 ? 's' : ''} found`);
    }

    function changePage(page) {
        if (page >= 0 && page < totalPages) {
            currentPage = page;
            loadProducts();
            $('html, body').animate({ scrollTop: 0 }, 'fast');
        }
    }

    function performSearch() {
        const searchTerm = $('#searchInput').val().trim();
        currentFilters.search = searchTerm;
        currentPage = 0;

        if (searchTerm) {
            $('#searchResultsHeader').show();
            $('#searchTerm').text(searchTerm);
        } else {
            $('#searchResultsHeader').hide();
        }

        loadProducts();
    }

    function applyPriceFilter() {
        const minPrice = $('#minPrice').val();
        const maxPrice = $('#maxPrice').val();

        currentFilters.minPrice = minPrice || null;
        currentFilters.maxPrice = maxPrice || null;
        currentPage = 0;
        loadProducts();
    }

    function applyAvailabilityFilter() {
        currentFilters.inStock = $('#inStock').is(':checked') ? true : null;
        currentFilters.featured = $('#featured').is(':checked') ? true : null;
        currentPage = 0;
        loadProducts();
    }

    function clearFilters() {
        currentFilters = {
            search: '',
            categoryId: null,
            minPrice: null,
            maxPrice: null,
            inStock: null,
            featured: null,
            sortBy: 'name',
            sortDir: 'asc',
            size: 12
        };
        currentPage = 0;

        // Reset form elements
        $('#searchInput').val('');
        $('#minPrice').val('');
        $('#maxPrice').val('');
        $('#inStock').prop('checked', false);
        $('#featured').prop('checked', false);
        $('#sortSelect').val('name-asc');
        $('#searchResultsHeader').hide();

        // Reset category filter
        $('.category-filter').removeClass('active');
        $('.category-filter[data-category="all"]').addClass('active');

        loadProducts();
    }

    function addToCart(productId) {
        if (!authToken) {
            window.location.href = '/login';
            return;
        }

        $.ajax({
            url: '/api/cart/add',
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + authToken,
                'Content-Type': 'application/json'
            },
            data: JSON.stringify({
                productId: productId,
                quantity: 1
            }),
            success: function(response) {
                if (response.success) {
                    showAlert('Product added to cart!', 'success');
                    updateCartCount();
                } else {
                    showAlert(response.message, 'danger');
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                showAlert(response?.message || 'Failed to add to cart', 'danger');
            }
        });
    }

    function updateCartCount() {
        if (!authToken) return;

        $.ajax({
            url: '/api/cart',
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + authToken
            },
            success: function(response) {
                if (response.success && response.data) {
                    const totalItems = response.data.items.reduce((sum, item) => sum + item.quantity, 0);
                    $('#cartCount').text(totalItems || 0);
                }
            }
        });
    }

    function showAlert(message, type) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show position-fixed"
                 style="top: 100px; right: 20px; z-index: 1050; min-width: 300px;">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        $('body').append(alertHtml);

        setTimeout(() => {
            $('.alert').alert('close');
        }, 3000);
    }
</script>
</body>
</html>